# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Рыбянцев Павел`

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

```
1.1. Для этой задачи подходит классическая схема ежедневного полного резервного копирования (Full Backup).
    Механизм:
        Раз в сутки (в часы минимальной нагрузки) создаётся полная копия всей базы данных.
    Особенности:
        Простота:
            Самый понятный метод восстановления — нужен только один файл бэкапа.
    Ресурсы: 
        Требует значительного времени на создание и большого объема хранилища.
    Риски: 
        В случае аварии данные,
        накопленные за текущий день (после последнего бэкапа),
        будут безвозвратно утеряны (RPO = 24 часа).

1.2. Здесь необходимо использовать инкрементальное копирование
или копирование журналов транзакций (Transaction Log Backup).
    Механизм:
        Раз в сутки делается полный бэкап,
        а затем каждый час (или чаще) копируются только изменения,
        произошедшие с момента последнего сохранения.
    Особенности:
        Точность:
            Позволяет минимизировать потерю данных до 1 часа (RPO = 1 час).
        Скорость:
            Инкрементальные копии создаются быстро, так как они небольшого размера.
        Сложность восстановления:
            Чтобы «поднять» базу на нужный момент,
            сначала восстанавливается последний полный бэкап,
            а затем последовательно применяются все почасовые изменения.

1.3 Моментальное переключение на работающую базу (Failover)
    Репликация: 
        Данные с бд (Master) в реальном времени передаются на резервную бд (Slave).
        В случае поломки основного сервера, резервный берет на себя нагрузку.
    Но репликация — это не замена бэкапу.
    Данный метод призван обеспечить высокую доступность (High Availability).
    В случае повреждения/удаления таблиц/данных, slave все отзеркалит. 
    Поэтому бэкап все равно необходим.
```

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

```bash
# Резервное копирование:

pg_dump -h localhost -U username -F c -b -v -f "my_db_backup.dump" database_name

# -F c: выбор кастомного формата (сжатый, оптимальный для pg_restore).
# -b: включение больших объектов (blobs).
# -v: подробный вывод (verbose).
```
```bash
# Восстановление данных:

pg_restore -h localhost -U username -d database_name -v "my_db_backup.dump"

# Если база данных еще не создана,
# можно добавить флаг -C (создать БД автоматически),
# но чаще восстанавливают в уже существующую пустую базу.
```
```
Автоматизация:
    Самое простое через скрипт и cron (планировщик задач)

    Создается bash-скрипт, в котором прописана команда pg_dump.
    Скрипт добавляется в crontab для запуска, например, каждую ночь в 03:00

     Пример: "0 3 * * * /полный/путь/к/скрипту/backup_pg.sh >> /var/log/pg_backup.log 2>&1"

    Важный нюанс:
        Чтобы скрипт не запрашивал пароль,
        используется файл .pgpass (создается в домашнем каталоге) или переменная окружения PGPASSWORD
        формат содержимого файла ~/.pgpass:
            localhost:5432:your_db_name:postgres:mypassword123
        Важно выдать ограниченные права на файл chmod 0600 ~/.pgpass, иначе PostgreSQL его пригнорирует.

Вариант автоматизации посложнее - pgBackRest:
    - Возможность гибкой настройки.
    - Инкрементальные бэкапы (только изменения).
    - Возможность автоматически удалять старые копии (Retention policy).
    - Проверять целостность архивов.

Ну и конечно надо переместить копию в надежное место, на другой сервер как минимум.
    - Можно использовать rclone (для S3 облачных хранилищ)
    - Или rsync (для копирования по SSH на удаленный хост)
```

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*
```
В отличие от PostgreSQL 
(который из коробки не умеет создавать инкрементные бэкапы),
 в MySQL основным механизмом для этого является бинарный лог (Binary Log).

 Для реализации инкрементального бэкапа в MySQL используем:
 Full Backup (через mysqldump) + Binary Logs.
```
`Включение логов в my.cnf`
```ini
[mysqld]
log-bin=mysql-bin
server-id=1
```
`Создание «точки отсчета» (полный бэкап)`
```bash
mysqldump -u root -p --all-databases --flush-logs --delete-master-logs --single-transaction > full_backup.sql

# -flush-logs: закрывает текущий файл бинарного лога и открывает новый.
# --single-transaction: позволяет сделать бэкап без блокировки таблиц.
```
`Инкрементное копирование (сохранение логов)`
```bash
# Все изменения,
# произошедшие после полного бэкапа,хранятся в файлах вида:
# mysql-bin.000001, mysql-bin.000002. 
# Чтобы сделать «инкрементный бэкап», достаточно просто скопировать эти файлы в безопасное место:

mysqladmin -u root -p flush-logs

# Теперь можно безопасно забирать предыдущие файлы логов из папки:
# /var/lib/mysql/
```
`Восстановление:`
```bash
# Сначала восстанавливается full_backup.sql,
# а затем по очереди применяются бинарные логи командой mysqlbinlog:

mysqlbinlog mysql-bin.000001 mysql-bin.000002 | mysql -u root -p
```
`Преимущества реплики перед обычным бэкапом:`
```
Использование реплики (Slave-сервера) дает финансовой компании несколько критических преимуществ:
Минимальное RTO (время восстановления):
Если основной сервер «упал», переключение на реплику занимает секунды или минуты. Восстановление из бэкапа (особенно если база весит терабайты) может занять часы.
Снятие нагрузки (Read Scaling):
На реплике можно строить тяжелые финансовые отчеты или делать аналитические выгрузки, не замедляя работу основного сервера, на котором клиенты совершают транзакции.
Бэкап без падения производительности:
Вы можете запускать mysqldump или копирование файлов прямо на реплике. При этом основной сервер (Master) не почувствует никакой нагрузки, и работа пользователей не замедлится.
Защита от физических аварий:
Если реплика находится в другом дата-центре, то пожар или наводнение в основном ЦОД не приведет к потере данных и остановке бизнеса.
```
---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.